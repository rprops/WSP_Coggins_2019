---
title: "Phenoflow_analysis3"
author: "Ruben Props"
date: "January 30, 2017"
output: html_document
---

Exploratory analysis for Liah Coggins.

# Description of data: 

AD141014: this is our first staining trial but not with the same stain as Liah which was brighter.  It is from one sites and has two locations: inlet and outlet.

**Notice:** _These data have been generated by a different FCM and are thus not comparable to the other data._

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = TRUE, 
                      echo = TRUE, 
                      cache = TRUE,
                      include = TRUE,
                      collapse = FALSE,
                      dependson = NULL,
                      engine = "R", # Chunks will always have R code, unless noted
                      error = TRUE,
                      fig.path="Figures/cached/",  # Set the figure options
                      fig.align = "center"
                      )
```

# Load libraries
```{r load-libraries, message = FALSE}
library("Phenoflow")
library("dplyr")
library("gridExtra")
library("ggplot2")
library("RColorBrewer")
# Settings for xyplot
my.settings <- list(
  strip.background=list(col="transparent"),
  strip.border=list(col="transparent", cex=5),
  gate=list(col=c("black"),fill="lightblue", alpha=0.5,lwd=4),
  panel.background=list(col="lightgray"),
  background=list(col="white"))
```

# Analysis
Here we follow the standard analysis workflow described here: https://github.com/rprops/Phenoflow_package/wiki/Phenotypic-diversity-analysis.
```{r denoising, fig.width = 10, fig.height = 5}

# Import data
path = "UWA_data/Staining"
flowData <- read.flowSet(path = path, transformation = FALSE, pattern=".fcs")

# Select the channels of interest 
flowData_transformed <- transform(flowData,`SYBR Green-A`=asinh(`SYBR Green-A`), 
                                  `SSC-A`=asinh(`SSC-A`), 
                                  `APC-Cy7-A`=asinh(`APC-Cy7-A`), 
                                  `FSC-A`=asinh(`FSC-A`))
param=c("SYBR Green-A", "APC-Cy7-A","SSC-A","FSC-A")
flowData_transformed = flowData_transformed[,param]
remove(flowData)

# Create a PolygonGate for denoising the dataset
sqrcut1 <- matrix(c(7,7,16,16,1,6.5,14.5,1),ncol=2, nrow=4)
colnames(sqrcut1) <- c("SYBR Green-A","APC-Cy7-A")
polyGate1 <- polygonGate(.gate=sqrcut1, filterId = "Total Cells")

# Use 4 samples to evaluate the gate
# Unfortunately there is still some spillover from potential (in)organics in certain samples. But if we want to have a consistent gating strategy, this is unavoidable.
xyplot(`APC-Cy7-A`~`SYBR Green-A`, data=flowData_transformed[5:8],
       filter=polyGate1,
       xbins=200,
       smooth=FALSE, xlim=c(0,14),ylim=c(0,16),
       par.settings=my.settings,
       margin=FALSE
      )

# Isolate only the cellular information based on the polyGate1
flowData_transformed <- Subset(flowData_transformed, polyGate1)

# Normalize all data based on the max SYBR Green-A intensity
summary <- fsApply(x=flowData_transformed,FUN=function(x) apply(x, 2, max),use.exprs=TRUE)
max = max(summary[,1])
mytrans <- function(x) x/max
flowData_transformed <- transform(flowData_transformed,`SYBR Green-A`=mytrans(`SYBR Green-A`),
                                  `APC-Cy7-A`=mytrans(`APC-Cy7-A`), 
                                  `SSC-A`=mytrans(`SSC-A`),
                                  `FSC-A`=mytrans(`FSC-A`))
```

Now that we've imported, denoised and normalized the data, we only proceed with the stained data.
Based on the sample names we extract the metadata. We also resample to the minimum sample size to account for sample size effects. This is necessary for sample sizes < 10,000.

```{r extract-meta}
# Extract metadata from sample names
meta <- strsplit(gsub(flowCore::sampleNames(flowData_transformed), pattern=".fcs", replacement=""), "_")
meta <- data.frame(Sample = flowCore::sampleNames(flowData_transformed), do.call(rbind,meta))
colnames(meta) <- c("Sample","Specimen", "Position", "Stained", "Dilution", "Percentage_stain", "random_ID")
head(meta)

# Select the sonicated data
flowData_transformed <- flowData_transformed[meta$Stained== "Stained"]

# Resample to 1000 cells and remove all samples with less than this sample size
flowData_transformed <- FCS_resample(flowData_transformed, replace = TRUE)
```

We are now ready to run the alpha-diversity analysis. Restricted the number of bootstraps to 10 for the sake of computational speed.

```{r run-alpha-div, message=FALSE}
# Run alpha diversity analysis
Diversity.ww <- Diversity_rf(flowData_transformed, d=3, param = param, R = 10)

# Merge results with metadata
results <- data.frame(Diversity.ww, meta[meta$Sample %in% flowCore::sampleNames(flowData_transformed),])
```

Next perform the beta-diversity analysis with only the Pond/Splitter samples (remove axenic cultures/WW)
```{r run-beta-div}
# Select the required samples
flowData_beta <- flowData_transformed

# Create fingerprint
fbasis <- flowBasis(flowData_beta, nbin=128, param=param, bw=0.01)

# Calculate PCoA
beta <- beta_div_fcm(fbasis, ord.type="PCoA")

# Calculate variance explained by axes
var <- round(vegan::eigenvals(beta)/sum(vegan::eigenvals(beta))*100,1)

# Merge results with metadata
beta_results <- data.frame(beta$points, meta[meta$Sample %in% flowCore::sampleNames(flowData_transformed),])
```

The analyses are done, now lets plot the results.

**Primary conclusions from the alpha-diversity analysis:**  

```{r plot-alpha, fig.width = 8, fig.height = 5}
a1 <- ggplot(data=results, aes(x=Position,y=D2, shape=Dilution))+
  scale_shape_manual(values=c(21,24))+
  geom_point(size=6, aes(fill=Percentage_stain))+
  scale_color_brewer(palette="Accent")+
  geom_errorbar(aes(ymin=D2-sd.D2, ymax=D2+sd.D2), width=0.05)+
  theme_bw()+
  labs(y="Phenotypic diversity (D2)", x="Timepoint")+
  guides(fill = guide_legend(override.aes = list(shape = 22)))

print(a1)
```

**Primary conclusions from the beta-diversity analysis:**  


```{r plot-beta, fig.width = 8, fig.height = 5}
b1 <- ggplot(data=beta_results, aes(x=X1, y=X2, fill=Percentage_stain, shape=Dilution))+
  scale_shape_manual(values=c(21,24))+
  geom_point(size=8)+
  theme_bw()+
  scale_color_brewer(palette="Accent")+
  labs(x = paste0("Axis1 (",var[1], "%)"), y = paste0("Axis2 (",var[2], "%)"))+
  theme(axis.text=element_text(size=14), axis.title=element_text(size=16,face="bold"),
        title=element_text(size=20), legend.text=element_text(size=14))+
  guides(fill = guide_legend(override.aes = list(shape = 22)))

print(b1)
```

Report session information
```{r session-info}
sessionInfo()
```

